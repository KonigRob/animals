<!DOCTYPE html>
<html lang="en">
<head>
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120643530-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'UA-120643530-1');
	</script>

	<meta charset="UTF-8">
	<title>New account</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCJuD5ep3swJpAbNgDl_ADFEqhyA0025UQ",
			authDomain: "pixelmeme-js.firebaseapp.com",
			databaseURL: "https://pixelmeme-js.firebaseio.com",
			projectId: "pixelmeme-js",
			storageBucket: "pixelmeme-js.appspot.com",
			messagingSenderId: "384650003816"
		};
		var app = firebase.initializeApp(config);
		var db = firebase.firestore(app);
		var storage = firebase.storage();
		let functions = firebase.functions();
	</script>
	<script>
		app.auth().onAuthStateChanged(function(user) {
			let isEmailVerified = $('#isEmailVerified');
			if (user) {
				if(user.displayName === null){
					document.title = user.email;
				} else {
					document.title = user.displayName;
				}
				if(user.emailVerified === false){
					isEmailVerified.show();
				} else {
					isEmailVerified.hide();
				}
			}
		});
		function updateEmail() {
			let user = firebase.auth().currentUser;
			console.log(user.uid);
			let newEmail = $('#emailText');
			user.updateEmail(newEmail.val()).then(function() {
				db.collection("users").doc(user.uid).set({
					userEmail: newEmail.val()
				});
				newEmail.val("");
			}).catch(function(error) {
				// An error happened.
			});
		}
		function updateDisplayName(){
			let user = firebase.auth().currentUser;
			let newDisplayName = $('#displayName');
			user.updateProfile({
				displayName: newDisplayName.val()
			}).then(function() {
				db.collection("users").doc(user.uid).update({
					displayName: user.displayName
				});
				newDisplayName.val("");
			}).catch(function(error) {
				// An error happened.
			});
		}
		function updatePassword(){
			let user = firebase.auth().currentUser;
			let newpassword = $('#pw');
			user.updatePassword(newpassword.val()).then(function() {
				console.log("password updated to: " + newpassword.val() + " !!");
				newpassword.val("");
			}).catch(function(error) {
				// An error happened.
			});
		}
		function deleteAccount(){
			let user = firebase.auth().currentUser;
			const userid = user.uid;
			let bool = prompt("Are you sure you want to delete your account? " +
				"All meme's accociated with this account will be deleted too.  " +
				"There is no way to undo this option." +
				"Please enter your password to continue",
				"");
				app.auth().signInWithEmailAndPassword(user.email, bool).then(function(){
					db.collection("users").doc(userid).delete().then(function() {
						console.log("user deleted from docs!");
						user.delete().then(function() {
							console.log("user deleted from auth")
							// window.location.replace("index.html");
						}).catch(function(error) {
							console.log(error);
						});
					}).catch(function(error) {
						console.error("Error removing document: ", error);
					});

				}).catch(function (error) {
					let errorCode = error.code;
					let errorMessage = error.message;
					console.log("EC: ", errorCode, " EM: ", errorMessage);
					if (errorCode === 'auth/wrong-password' || errorCode === 'auth/user-not-found') {
						alert(errorCode);
					} else {
						alert(errorMessage);
					}
				});
		}
		function verifyEmail() {
			let user = firebase.auth().currentUser;
			user.sendEmailVerification().then(function () {
				console.log("Email sent to: " + user.email + ".")
			}).catch(function (error) {
				// An error happened.
			});
		}
		$(function () {
			let i = 0;
			let adminWindow = $('#adminPanelList');
			db.collection("requested-memes").get().then(function (querySnapshot) {
				querySnapshot.forEach(function (doc) {
					// console.log("id: ", doc.id);
					// console.log("fileLink: ", doc.data().fileLink);
					// console.log('<li><img src="'+doc.data().fileLink+'"></li>');
					const uid = "butter";
					let imageOfMeme = '<img width="200px" src="'+doc.data().fileLink+'">';
					let userLink = '<a href="'+doc.data().website+'" target="_blank">website: "'+doc.data().website+'"</a>';
					// let breakSpaces = '<br /><br />';
					let yesBtn = '<button class="yesClick'+i+'">Yes</button>';
					let noBtn = '<button class="noClick'+i+'">No</button>';
					// console.log(doc.id);
					adminWindow.prepend('<li>'+imageOfMeme+userLink+yesBtn+noBtn+'</li>');
					$('.yesClick'+i).click(function () {
						alert(doc.id);
					});
					$('.noClick'+i).click(function () {
						alert(doc.id);
					});
					i++;
				});
			});
			// $('#adminPanel').html('<h1>Hello world</h1>');
			// storage.ref('requested-memes').getDownloadURL().then(function (value) {
			// 	console.log(value);
			// });
		});
	</script>
</head>
<body>
	<label for="displayName">Change display name:</label>
	<input id="displayName">
	<button onclick="updateDisplayName()">Submit</button><br />
	<label for="emailText">Change email:</label>
	<input id="emailText">
	<button onclick="updateEmail()">Submit</button><br />
	<label for="pw">Change password:</label>
	<input id="pw">
	<button onclick="updatePassword()">Submit</button><br />
	<button id="isEmailVerified" onclick="verifyEmail()">Verify Email</button><br />
	<button onclick="deleteAccount()">Delete Account</button><br />
	<div id="adminPanel"> <!-- Creating the table of info and pictures  MAKE this hidden by default -->
		<ul id="adminPanelList">
		</ul>
	</div>
	<a href="index.html">Back to home</a>
</body>
</html>
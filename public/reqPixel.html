<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120643530-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-120643530-1');
	</script>
	<meta charset="UTF-8">
	<title>Buy a Pixel</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.12.0/firebase-firestore.js"></script>
	<script>
		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyCJuD5ep3swJpAbNgDl_ADFEqhyA0025UQ",
			authDomain: "pixelmeme-js.firebaseapp.com",
			databaseURL: "https://pixelmeme-js.firebaseio.com",
			projectId: "pixelmeme-js",
			storageBucket: "pixelmeme-js.appspot.com",
			messagingSenderId: "384650003816"
		};
		var app = firebase.initializeApp(config);
		var db = firebase.firestore(app);
		var storage = firebase.storage();
	</script>
	<style>
		div {
			margin: 20px;
		}
	</style>
</head>
<body>
<h1>
	hi
</h1>
<!--<form action="javascript:" onsubmit="uploadFile(this);">-->
<div>
	Select meme to upload:
	<input type="file" name="imageToUpload" id="imageToUpload">
	Width:<input type="number" id="widthX" name="photoWidth" title="Width" min="0" max="999">
	Height:<input type="number" id="heightY" name="photoHeight" title="Height" min="0" max="999">
	<input type="radio" name="size" value="10" id="tinySq" title="tiny" checked required> 10x10
	<input type="radio" name="size" value="20" id="smallSq" title="small"> 20x20
	<input type="radio" name="size" value="30" id="mediumSq" title="medium"> 30x30
	<input type="radio" name="size" value="40" id="largeSq" title="large"> 40x40
	<input type="text" name="userid" id="userid" hidden>
	Link:<input type="text" id="hyperLink" title="link">
	<button onclick="uploadFile()">Submit</button>
	<!--<input type="submit" value="Buy" name="submit">-->
<!--</form>-->
</div>

<a href="index.html">console</a>

<img id="mememap" src="" border="2" alt="meme Map">


<script>

</script>


<script>
	function uploadFile(){
		let x = $('#widthX');
		let y = $('#heightY');
		let link = $('#hyperLink').val();
		let size = 10;
		if($('#tinySq').prop("checked")) {
			size = 10;
		} else if($('#smallSq').prop("checked")){
			size = 20;
		} else if($("#mediumSq").prop("checked")){
			size = 30;
		} else {
			size = 40;
		}
		if($.isNumeric(x.val())){
			console.log('x coord is: ' + x.val());
		}
		if($.isNumeric(y.val())){
			console.log('y coord is: ' + y.val())
		}
		let filename = $('#imageToUpload').prop('files')[0];
		let user = firebase.auth().currentUser;
		const time = $.now();
		let uploadTask = firebase.storage().ref('requested-memes/' + user.uid + "_" + time).put(filename);
		uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
			function(snapshot) {
				// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
				let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
				console.log('Upload is ' + progress + '% done');
				switch (snapshot.state) {
					case firebase.storage.TaskState.PAUSED: // or 'paused'
						console.log('Upload is paused');
						break;
					case firebase.storage.TaskState.RUNNING: // or 'running'
						console.log('Upload is running');
						break;
				}
			}, function(error) {

				// A full list of error codes is available at
				// https://firebase.google.com/docs/storage/web/handle-errors
				switch (error.code) {
					case 'storage/unauthorized':
						// User doesn't have permission to access the object
						break;

					case 'storage/canceled':
						// User canceled the upload
						break;

					case 'storage/unknown':
						// Unknown error occurred, inspect error.serverResponse
						break;
				}
			}, function() {
				// Upload completed successfully, now we can get the download URL
				uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
					db.collection("requested-memes").doc((user.uid+"_"+time).toString()).set({
						userID:user.uid,
						time:time,
						fileLink: downloadURL,
						x:x.val(),
						y:y.val(),
						sizeOfSquare:size,
						website:link
					});
				});
				// uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
				// 	var docRef = db.collection("users").doc(user.uid);
				// 	let requestion = {
				// 		[time]:
				// 		{
				// 			location: downloadURL,
				// 			x: x.val(),
				// 			y: y.val(),
				// 			sizeOfSquare: size,
				// 			website: link
				// 		}
				// 	};
				// 	db.collection("users").doc(user.uid).update(requestion).then(function () {
				// 		console.log("Successfully written to database")
				// 	});
				// 	console.log('File available at', downloadURL);
				// });
			});
	}
	$(function () {
		storage.ref('meme-map/meme-map.png').getDownloadURL().then(function (value) {
			$('#mememap').attr('src', value);
		});
		$('#mememap').click(function (event) {
			var map = $('#mememap');
			var horizontal = event.pageX - map.position().left - 2;
			var vertical = event.pageY - map.position().top - 2.125;
			if (horizontal < 0) {
				horizontal = 0;
			} else if (horizontal > 1000) {
				horizontal = 1000;
			}
			if (vertical < 0) {
				vertical = 0;
			} else if (vertical > 1000) {
				vertical = 1000;
			}
			$('#widthX').val(Math.round(horizontal));
			$('#heightY').val(Math.round(vertical));
		});
		// $('#tinySq').change((function () {
		// 	alert("tiny");
		// }));
		// $('#smallSq').change((function () {
		// 	alert("small");
		// }));
		// $('#mediumSq').change((function () {
		// 	alert("medium");
		// }));
		// $('#largeSq').change((function () {
		// 	alert("large");
		// }));
	});
	app.auth().onAuthStateChanged(function (user){
		if(user){
			$('#userid').val(user.uid);
		} else {
			window.location.replace("index.html");
		}
	});
</script>
</body>
</html>